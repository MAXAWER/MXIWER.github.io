<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой Мессенджер на Firebase</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: scroll; margin-bottom: 10px; }
        #message-form input { width: calc(100% - 80px); padding: 8px; }
        #message-form button { width: 70px; padding: 8px; }
        .msg { margin: 5px 0; }
    </style>
</head>
<body>

    <h1>Простой Мессенджер</h1>
    
    <div id="messages">
        <p>Загрузка...</p>
    </div>
    
    <div id="message-form">
        <input type="text" id="username-input" placeholder="Ваше имя" value="Аноним">
        <input type="text" id="message-input" placeholder="Введите сообщение...">
        <button id="send-button">Отправить</button>
    </div>

    <script type="module">
      // ШАГ 1: Импортируем нужные функции из Firebase SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      // Добавляем импорты для работы с Realtime Database
      import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      // ШАГ 2: Ваша конфигурация Firebase (вставьте сюда вашу, с НОВЫМ ключом)
      const firebaseConfig = {
        apiKey: "AIzaSyDMB6joYk4W37-_q64NMVHDMfLKjO4zlIQ",
        authDomain: "mxi-222.firebaseapp.com",
        projectId: "mxi-222",
        databaseURL: "https://mxi-222-default-rtdb.europe-west1.firebasedatabase.app", 
        storageBucket: "mxi-222.appspot.com",
        messagingSenderId: "97121151340",
        appId: "1:97121151340:web:fc00a8e93d774e3a822b49"
      };

      // ШАГ 3: Инициализация Firebase и получение доступа к базе данных
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      // Создаем "ссылку" на место в базе, где будут храниться все сообщения.
      // Назовем его 'messages'.
      const messagesRef = ref(database, 'messages');


      // ШАГ 4: Получаем ссылки на наши HTML-элементы
      const messagesDiv = document.getElementById('messages');
      const usernameInput = document.getElementById('username-input');
      const messageInput = document.getElementById('message-input');
      const sendButton = document.getElementById('send-button');

      // ШАГ 5: ЛОГИКА ОТПРАВКИ СООБЩЕНИЙ
      function sendMessage() {
        const username = usernameInput.value;
        const message = messageInput.value;

        // Простая проверка, чтобы не отправлять пустые сообщения
        if (username.trim() === '' || message.trim() === '') {
          alert('Пожалуйста, введите имя и сообщение.');
          return;
        }

        // Команда push() отправляет данные в базу данных по нашей ссылке (messagesRef)
        // и автоматически создает уникальный ID для каждого сообщения.
        push(messagesRef, {
          username: username,
          text: message,
          timestamp: Date.now() // Добавим время отправки
        });

        // Очищаем поле ввода сообщения
        messageInput.value = '';
        messageInput.focus(); // Возвращаем фокус на поле ввода
      }

      // Привязываем функцию sendMessage к нажатию на кнопку
      sendButton.addEventListener('click', sendMessage);
      // И к нажатию клавиши Enter в поле ввода сообщения
      messageInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
          sendMessage();
        }
      });

      // ШАГ 6: ЛОГИКА ПОЛУЧЕНИЯ СООБЩЕНИЙ (МАГИЯ РЕАЛЬНОГО ВРЕМЕНИ)
      // onChildAdded() - это "слушатель", который срабатывает КАЖДЫЙ раз,
      // когда в 'messages' добавляется новое сообщение (включая старые при первой загрузке).
      onChildAdded(messagesRef, (snapshot) => {
        // snapshot.val() содержит само сообщение (объект {username, text, timestamp})
        const msg = snapshot.val();
        
        // Создаем новый HTML-элемент для сообщения
        const messageElement = document.createElement('div');
        messageElement.classList.add('msg'); // для стилей
        messageElement.innerHTML = `<strong>${msg.username}:</strong> ${msg.text}`;

        // При первой загрузке очищаем надпись "Загрузка..."
        if (messagesDiv.innerHTML.includes('Загрузка...')) {
          messagesDiv.innerHTML = '';
        }
        
        // Добавляем сообщение в наш div
        messagesDiv.appendChild(messageElement);

        // Автоматически прокручиваем чат вниз к последнему сообщению
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

    </script>
</body>
</html>
